# ============================================================
# vTTS API Gateway - Nginx Configuration
# ============================================================
# 여러 TTS 엔진을 단일 엔드포인트로 라우팅
#
# 라우팅 규칙:
#   - model=Supertone/* → supertonic:8000
#   - model=*GPT-SoVITS* → gptsovits:8000
#   - model=*CosyVoice* → cosyvoice:8000
#   - 기본값 → supertonic:8000
# ============================================================

events {
    worker_connections 1024;
}

http {
    # ============================================================
    # Upstream 서버 정의
    # ============================================================
    upstream supertonic {
        server supertonic:8000;
    }

    upstream gptsovits {
        server gptsovits:8000;
    }

    upstream cosyvoice {
        server cosyvoice:8000;
    }

    # ============================================================
    # 로그 설정
    # ============================================================
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" rt=$request_time '
                    'upstream=$upstream_addr';

    access_log /var/log/nginx/access.log main;
    error_log /var/log/nginx/error.log warn;

    # ============================================================
    # 서버 설정
    # ============================================================
    server {
        listen 80;
        server_name _;

        # 큰 오디오 파일 처리
        client_max_body_size 100M;
        
        # 타임아웃 설정 (TTS는 시간이 오래 걸릴 수 있음)
        proxy_connect_timeout 60s;
        proxy_send_timeout 120s;
        proxy_read_timeout 120s;

        # ============================================================
        # 헬스체크
        # ============================================================
        location /health {
            return 200 '{"status": "ok", "gateway": "nginx"}';
            add_header Content-Type application/json;
        }

        # ============================================================
        # API 문서 (기본: Supertonic)
        # ============================================================
        location /docs {
            proxy_pass http://supertonic/docs;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        location /openapi.json {
            proxy_pass http://supertonic/openapi.json;
            proxy_set_header Host $host;
        }

        # ============================================================
        # 모델 목록
        # ============================================================
        location /v1/models {
            # 모든 엔진의 모델 목록을 합쳐서 반환 (향후 구현)
            proxy_pass http://supertonic/v1/models;
            proxy_set_header Host $host;
        }

        # ============================================================
        # TTS 엔드포인트 - 모델 기반 라우팅
        # ============================================================
        location /v1/audio/speech {
            # Lua 또는 NJS 모듈로 동적 라우팅 가능
            # 간단히 기본값으로 Supertonic 사용
            proxy_pass http://supertonic/v1/audio/speech;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        # ============================================================
        # 엔진별 직접 접근 (명시적 라우팅)
        # ============================================================
        
        # Supertonic 직접 접근
        location /supertonic/ {
            rewrite ^/supertonic/(.*)$ /$1 break;
            proxy_pass http://supertonic;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        # GPT-SoVITS 직접 접근
        location /gptsovits/ {
            rewrite ^/gptsovits/(.*)$ /$1 break;
            proxy_pass http://gptsovits;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        # CosyVoice 직접 접근
        location /cosyvoice/ {
            rewrite ^/cosyvoice/(.*)$ /$1 break;
            proxy_pass http://cosyvoice;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        # ============================================================
        # STT 엔드포인트
        # ============================================================
        location /v1/audio/transcriptions {
            # STT는 Supertonic 컨테이너에서 처리
            proxy_pass http://supertonic/v1/audio/transcriptions;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        # ============================================================
        # 기본 (모든 요청 → Supertonic)
        # ============================================================
        location / {
            proxy_pass http://supertonic;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }
    }
}
