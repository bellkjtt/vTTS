# ============================================================
# vTTS - GPT-SoVITS Engine Docker Image
# ============================================================
# 고품질 음성 클로닝 TTS 엔진
# 
# Build:
#   docker build -f docker/Dockerfile.gptsovits -t vtts:gptsovits .
#
# Run:
#   docker run -p 8001:8000 --gpus all vtts:gptsovits
#
# 주의: 이 이미지는 의존성이 많아 빌드 시간이 오래 걸립니다 (~15분)
# ============================================================

FROM nvidia/cuda:12.1.0-cudnn8-runtime-ubuntu22.04

LABEL maintainer="vTTS Contributors"
LABEL description="vTTS with GPT-SoVITS TTS Engine (Voice Cloning)"
LABEL engine="gptsovits"

# ============================================================
# 환경 변수
# ============================================================
ENV DEBIAN_FRONTEND=noninteractive
ENV PYTHONUNBUFFERED=1
ENV PYTHONDONTWRITEBYTECODE=1

# HuggingFace 캐시 디렉토리
ENV HF_HOME=/root/.cache/huggingface
ENV TRANSFORMERS_CACHE=/root/.cache/huggingface

# ============================================================
# 시스템 패키지 설치 (GPT-SoVITS 의존성 포함)
# ============================================================
RUN apt-get update && apt-get install -y --no-install-recommends \
    python3.10 \
    python3.10-dev \
    python3-pip \
    ffmpeg \
    libsndfile1 \
    git \
    curl \
    # GPT-SoVITS 추가 의존성
    build-essential \
    cmake \
    libmecab-dev \
    mecab \
    mecab-ipadic-utf8 \
    swig \
    && rm -rf /var/lib/apt/lists/* \
    && ln -sf /usr/bin/python3.10 /usr/bin/python3 \
    && ln -sf /usr/bin/python3.10 /usr/bin/python

# pip 업그레이드
RUN pip3 install --no-cache-dir --upgrade pip setuptools wheel

# ============================================================
# 작업 디렉토리
# ============================================================
WORKDIR /app

# ============================================================
# Python 의존성 설치 (레이어 캐싱 최적화)
# ============================================================

# 1. PyTorch 먼저 설치 (CUDA 버전)
RUN pip3 install --no-cache-dir \
    torch==2.1.0+cu121 \
    torchaudio==2.1.0+cu121 \
    --index-url https://download.pytorch.org/whl/cu121

# 2. setup.py 복사
COPY setup.py pyproject.toml ./
COPY vtts/__init__.py vtts/

# 3. GPT-SoVITS 의존성 설치 (시간 오래 걸림)
RUN pip3 install --no-cache-dir \
    funasr>=1.0.27 \
    peft>=0.10.0,<0.18.0 \
    g2p_en \
    cn2an \
    pypinyin \
    sentencepiece \
    jieba \
    fast_langdetect \
    g2pk2 \
    ko_pron

# 4. pyopenjtalk 별도 설치 (컴파일 필요)
RUN pip3 install --no-cache-dir pyopenjtalk

# 5. vTTS 설치
RUN pip3 install --no-cache-dir -e .

# ============================================================
# 앱 복사
# ============================================================
COPY . .

# ============================================================
# 포트 및 헬스체크
# ============================================================
EXPOSE 8000

HEALTHCHECK --interval=30s --timeout=10s --start-period=120s --retries=3 \
    CMD curl -f http://localhost:8000/health || exit 1

# ============================================================
# 엔트리포인트
# ============================================================
ENTRYPOINT ["vtts", "serve"]
CMD ["kevinwang676/GPT-SoVITS-v3", "--host", "0.0.0.0", "--port", "8000", "--device", "auto"]
